<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eval Review</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&family=Lora:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js" integrity="sha384-EnyY0/GSHQGSxSgMwaIPzSESbqoOLSexfnSMN2AP+39Ckmn92stwABZynq1JyzdT" crossorigin="anonymous"></script>
  <style>
    :root {
      --bg: #faf9f5;
      --surface: #ffffff;
      --border: #e8e6dc;
      --text: #141413;
      --text-muted: #b0aea5;
      --accent: #d97757;
      --accent-hover: #c4613f;
      --green: #788c5d;
      --green-bg: #eef2e8;
      --red: #c44;
      --red-bg: #fceaea;
      --header-bg: #141413;
      --header-text: #faf9f5;
      --radius: 6px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Lora', Georgia, serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ---- Header ---- */
    .header {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .header h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .header .instructions {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-top: 0.25rem;
    }
    .header .progress {
      font-size: 0.875rem;
      opacity: 0.8;
      text-align: right;
    }

    /* ---- Main content ---- */
    .main {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    /* ---- Sections ---- */
    .section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      flex-shrink: 0;
    }
    .section-header {
      font-family: 'Poppins', sans-serif;
      padding: 0.75rem 1rem;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .section-body {
      padding: 1rem;
    }

    /* ---- Config badge ---- */
    .config-badge {
      display: inline-block;
      padding: 0.2rem 0.625rem;
      border-radius: 9999px;
      font-family: 'Poppins', sans-serif;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-left: 0.75rem;
      vertical-align: middle;
    }
    .config-badge.config-primary {
      background: rgba(33, 150, 243, 0.12);
      color: #1976d2;
    }
    .config-badge.config-baseline {
      background: rgba(255, 193, 7, 0.15);
      color: #f57f17;
    }

    /* ---- Prompt ---- */
    .prompt-text {
      white-space: pre-wrap;
      font-size: 0.9375rem;
      line-height: 1.6;
    }

    /* ---- Outputs ---- */
    .output-file {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .output-file + .output-file {
      margin-top: 1rem;
    }
    .output-file-header {
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .output-file-header .dl-btn {
      font-size: 0.7rem;
      color: var(--accent);
      text-decoration: none;
      cursor: pointer;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-weight: 500;
      opacity: 0.8;
    }
    .output-file-header .dl-btn:hover {
      opacity: 1;
      text-decoration: underline;
    }
    .output-file-content {
      padding: 0.75rem;
      overflow-x: auto;
    }
    .output-file-content pre {
      font-size: 0.8125rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
    }
    .output-file-content img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }
    .output-file-content iframe {
      width: 100%;
      height: 600px;
      border: none;
    }
    .output-file-content table {
      border-collapse: collapse;
      font-size: 0.8125rem;
      width: 100%;
    }
    .output-file-content table td,
    .output-file-content table th {
      border: 1px solid var(--border);
      padding: 0.375rem 0.5rem;
      text-align: left;
    }
    .output-file-content table th {
      background: var(--bg);
      font-weight: 600;
    }
    .output-file-content .download-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--accent);
      text-decoration: none;
      font-size: 0.875rem;
      cursor: pointer;
    }
    .output-file-content .download-link:hover {
      background: var(--border);
    }
    .empty-state {
      color: var(--text-muted);
      font-style: italic;
      padding: 2rem;
      text-align: center;
    }

    /* ---- Feedback ---- */
    .prev-feedback {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.625rem 0.75rem;
      margin-top: 0.75rem;
      font-size: 0.8125rem;
      color: var(--text-muted);
      line-height: 1.5;
    }
    .prev-feedback-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.25rem;
      color: var(--text-muted);
    }
    .feedback-textarea {
      width: 100%;
      min-height: 100px;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.9375rem;
      line-height: 1.5;
      resize: vertical;
      color: var(--text);
    }
    .feedback-textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .feedback-status {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      min-height: 1.1em;
    }

    /* ---- Grades (collapsible) ---- */
    .grades-toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .grades-toggle:hover {
      color: var(--accent);
    }
    .grades-toggle .arrow {
      margin-right: 0.5rem;
      transition: transform 0.15s;
      font-size: 0.75rem;
    }
    .grades-toggle .arrow.open {
      transform: rotate(90deg);
    }
    .grades-content {
      display: none;
      margin-top: 0.75rem;
    }
    .grades-content.open {
      display: block;
    }
    .grades-summary {
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .grade-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .grade-pass { background: var(--green-bg); color: var(--green); }
    .grade-fail { background: var(--red-bg); color: var(--red); }
    .assertion-list {
      list-style: none;
    }
    .assertion-item {
      padding: 0.625rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.8125rem;
    }
    .assertion-item:last-child { border-bottom: none; }
    .assertion-status {
      font-weight: 600;
      margin-right: 0.5rem;
    }
    .assertion-status.pass { color: var(--green); }
    .assertion-status.fail { color: var(--red); }
    .assertion-evidence {
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-top: 0.25rem;
      padding-left: 1.5rem;
    }

    /* ---- View tabs ---- */
    .view-tabs {
      display: flex;
      gap: 0;
      padding: 0 2rem;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .view-tab {
      font-family: 'Poppins', sans-serif;
      padding: 0.625rem 1.25rem;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      background: none;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }
    .view-tab:hover { color: var(--text); }
    .view-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .view-panel { display: none; }
    .view-panel.active { display: flex; flex-direction: column; flex: 1; overflow: hidden; }

    /* ---- Benchmark view ---- */
    .benchmark-view {
      padding: 1.5rem 2rem;
      overflow-y: auto;
      flex: 1;
    }
    .benchmark-table {
      border-collapse: collapse;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.8125rem;
      width: 100%;
      margin-bottom: 1.5rem;
    }
    .benchmark-table th, .benchmark-table td {
      padding: 0.625rem 0.75rem;
      text-align: left;
      border: 1px solid var(--border);
    }
    .benchmark-table th {
      font-family: 'Poppins', sans-serif;
      background: var(--header-bg);
      color: var(--header-text);
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .benchmark-table tr:hover { background: var(--bg); }
    .benchmark-table tr.benchmark-row-with { background: rgba(33, 150, 243, 0.06); }
    .benchmark-table tr.benchmark-row-without { background: rgba(255, 193, 7, 0.06); }
    .benchmark-table tr.benchmark-row-with:hover { background: rgba(33, 150, 243, 0.12); }
    .benchmark-table tr.benchmark-row-without:hover { background: rgba(255, 193, 7, 0.12); }
    .benchmark-table tr.benchmark-row-avg { font-weight: 600; border-top: 2px solid var(--border); }
    .benchmark-table tr.benchmark-row-avg.benchmark-row-with { background: rgba(33, 150, 243, 0.12); }
    .benchmark-table tr.benchmark-row-avg.benchmark-row-without { background: rgba(255, 193, 7, 0.12); }
    .benchmark-delta-positive { color: var(--green); font-weight: 600; }
    .benchmark-delta-negative { color: var(--red); font-weight: 600; }
    .benchmark-notes {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
    }
    .benchmark-notes h3 {
      font-family: 'Poppins', sans-serif;
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
    }
    .benchmark-notes ul {
      list-style: disc;
      padding-left: 1.25rem;
    }
    .benchmark-notes li {
      font-size: 0.8125rem;
      line-height: 1.6;
      margin-bottom: 0.375rem;
    }
    .benchmark-empty {
      color: var(--text-muted);
      font-style: italic;
      text-align: center;
      padding: 3rem;
    }

    /* ---- Navigation ---- */
    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }
    .nav-btn {
      font-family: 'Poppins', sans-serif;
      padding: 0.5rem 1.25rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
      transition: all 0.15s;
    }
    .nav-btn:hover:not(:disabled) {
      background: var(--bg);
      border-color: var(--text-muted);
    }
    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .done-btn {
      font-family: 'Poppins', sans-serif;
      padding: 0.5rem 1.5rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.15s;
    }
    .done-btn:hover {
      background: var(--bg);
      border-color: var(--text-muted);
    }
    .done-btn.ready {
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 600;
    }
    .done-btn.ready:hover {
      background: var(--accent-hover);
    }
    /* ---- Done overlay ---- */
    .done-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .done-overlay.visible {
      display: flex;
    }
    .done-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 2rem 3rem;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
    }
    .done-card h2 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .done-card p {
      color: var(--text-muted);
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    .done-card .btn-row {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }
    .done-card button {
      padding: 0.5rem 1.25rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      cursor: pointer;
      font-size: 0.875rem;
    }
    .done-card button:hover {
      background: var(--bg);
    }
    /* ---- Toast ---- */
    .toast {
      position: fixed;
      bottom: 5rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--header-bg);
      color: var(--header-text);
      padding: 0.625rem 1.25rem;
      border-radius: var(--radius);
      font-size: 0.875rem;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 200;
    }
    .toast.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="app" style="height:100vh; display:flex; flex-direction:column;">
    <div class="header">
      <div>
        <h1>Eval Review: <span id="skill-name"></span></h1>
        <div class="instructions">Review each output and leave feedback below. Navigate with arrow keys or buttons. When done, copy feedback and paste into Claude Code.</div>
      </div>
      <div class="progress" id="progress"></div>
    </div>

    <!-- View tabs (only shown when benchmark data exists) -->
    <div class="view-tabs" id="view-tabs" style="display:none;">
      <button class="view-tab active" onclick="switchView('outputs')">Outputs</button>
      <button class="view-tab" onclick="switchView('benchmark')">Benchmark</button>
    </div>

    <!-- Outputs panel (qualitative review) -->
    <div class="view-panel active" id="panel-outputs">
    <div class="main">
      <!-- Prompt -->
      <div class="section">
        <div class="section-header">Prompt <span class="config-badge" id="config-badge" style="display:none;"></span></div>
        <div class="section-body">
          <div class="prompt-text" id="prompt-text"></div>
        </div>
      </div>

      <!-- Outputs -->
      <div class="section">
        <div class="section-header">Output</div>
        <div class="section-body" id="outputs-body">
          <div class="empty-state">No output files found</div>
        </div>
      </div>

      <!-- Previous Output (collapsible) -->
      <div class="section" id="prev-outputs-section" style="display:none;">
        <div class="section-header">
          <div class="grades-toggle" onclick="togglePrevOutputs()">
            <span class="arrow" id="prev-outputs-arrow">&#9654;</span>
            Previous Output
          </div>
        </div>
        <div class="grades-content" id="prev-outputs-content"></div>
      </div>

      <!-- Grades (collapsible) -->
      <div class="section" id="grades-section" style="display:none;">
        <div class="section-header">
          <div class="grades-toggle" onclick="toggleGrades()">
            <span class="arrow" id="grades-arrow">&#9654;</span>
            Formal Grades
          </div>
        </div>
        <div class="grades-content" id="grades-content"></div>
      </div>

      <!-- Feedback -->
      <div class="section">
        <div class="section-header">Your Feedback</div>
        <div class="section-body">
          <textarea
            class="feedback-textarea"
            id="feedback"
            placeholder="What do you think of this output? Any issues, suggestions, or things that look great?"
          ></textarea>
          <div class="feedback-status" id="feedback-status"></div>
          <div class="prev-feedback" id="prev-feedback" style="display:none;">
            <div class="prev-feedback-label">Previous feedback</div>
            <div id="prev-feedback-text"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="nav" id="outputs-nav">
      <button class="nav-btn" id="prev-btn" onclick="navigate(-1)">&#8592; Previous</button>
      <button class="done-btn" id="done-btn" onclick="showDoneDialog()">Submit All Reviews</button>
      <button class="nav-btn" id="next-btn" onclick="navigate(1)">Next &#8594;</button>
    </div>
    </div><!-- end panel-outputs -->

    <!-- Benchmark panel (quantitative stats) -->
    <div class="view-panel" id="panel-benchmark">
      <div class="benchmark-view" id="benchmark-content">
        <div class="benchmark-empty">No benchmark data available. Run a benchmark to see quantitative results here.</div>
      </div>
    </div>
  </div>

  <!-- Done overlay -->
  <div class="done-overlay" id="done-overlay">
    <div class="done-card">
      <h2>Review Complete</h2>
      <p>Your feedback has been saved. Go back to your Claude Code session and tell Claude you're done reviewing.</p>
      <div class="btn-row">
        <button onclick="closeDoneDialog()">OK</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ---- Embedded data (injected by generate_review.py) ----
    const EMBEDDED_DATA = {"skill_name": "design-workflow", "runs": [{"id": "eval-platformer-design-with_skill-run-1", "prompt": "(No prompt found)", "eval_id": null, "outputs": [], "grading": {"expectations": [{"text": "A docs_for_ai/ directory is created with proper subdirectories (game_design/ and implementation/)", "passed": true, "evidence": "Directory listing confirms: outputs/docs_for_ai/ contains game_design/ and implementation/ subdirectories. Transcript Step 5 explicitly states: 'Created outputs/docs_for_ai/', 'Created outputs/docs_for_ai/game_design/', 'Created outputs/docs_for_ai/implementation/'."}, {"text": "GameDesignOverview.md is created at docs_for_ai/GameDesignOverview.md", "passed": true, "evidence": "File exists at outputs/docs_for_ai/GameDesignOverview.md (4124 bytes). Content is substantive: full game design document for 'Purrfect Run' with 8 sections including Game Overview, Core Concept, World and Setting, Design File Manifest, Cross-Cutting Concerns, Technical Requirements, Content Scope Summary, and Notes."}, {"text": "ImplementationPlanOverview.md is created at docs_for_ai/ImplementationPlanOverview.md", "passed": true, "evidence": "File exists at outputs/docs_for_ai/ImplementationPlanOverview.md (6212 bytes). Content is substantive: includes Project Structure, Phase Summary, Implementation File Manifest, Key Constants, Dependencies, and Testing Strategy sections."}, {"text": "All documents are written in English", "passed": true, "evidence": "All files read (GameDesignOverview.md, ImplementationPlanOverview.md, 01_Player_Design.md, 02_Collectibles_Design.md, 01_Player_Implementation.md) are written entirely in English. No non-English text found in any sampled document."}, {"text": "Variable values are marked with [EXAMPLE: value] notation", "passed": true, "evidence": "Multiple instances of [EXAMPLE:] notation confirmed across files. In GameDesignOverview.md: '[EXAMPLE: 30-60 minutes]', '[EXAMPLE: 60 FPS]', '[EXAMPLE: < 3 seconds]', '[EXAMPLE: 10-20 per level]'. In ImplementationPlanOverview.md: '[EXAMPLE: 6.0f]', '[EXAMPLE: 12.0f]', '[EXAMPLE: 0.12f]', etc. In 01_Player_Design.md: '[EXAMPLE: 6.0 units/sec]', '[EXAMPLE: 12.0 units]', '[EXAMPLE: 0.12 seconds]'."}, {"text": "The documents include a File Manifest section listing all detail files", "passed": true, "evidence": "GameDesignOverview.md has '## 4. Design File Manifest' table listing all 4 design detail files with filename, domain, and description. ImplementationPlanOverview.md has '## 3. Implementation File Manifest' table listing all 5 implementation detail files. Both manifests use markdown table format with hyperlinks to the referenced files."}, {"text": "At least one game design detail file is created in docs_for_ai/game_design/", "passed": true, "evidence": "Four game design detail files confirmed in docs_for_ai/game_design/: 01_Player_Design.md (2735 bytes), 02_Collectibles_Design.md (2547 bytes), 03_Enemies_Design.md (2865 bytes), 04_LevelContent_Design.md (2996 bytes). Sampled files contain substantive content with Mechanics, Entities, Player Actions, Progression, and Dependencies sections."}, {"text": "At least one implementation detail file is created in docs_for_ai/implementation/", "passed": true, "evidence": "Five implementation detail files confirmed in docs_for_ai/implementation/: 01_Player_Implementation.md (5294 bytes), 02_Collectibles_Implementation.md (4393 bytes), 03_Enemies_Implementation.md (4763 bytes), 04_LevelContent_Implementation.md (5299 bytes), 05_UIAndPolish_Implementation.md (4924 bytes). Sampled 01_Player_Implementation.md contains Architecture (class definitions with properties and methods), State Management diagram, Tasks, System-Specific Constants, Asset Requirements, and Dependencies sections."}], "summary": {"passed": 8, "failed": 0, "total": 8, "pass_rate": 1.0}, "execution_metrics": {"tool_calls": {}, "total_tool_calls": null, "total_steps": 10, "errors_encountered": 0, "output_chars": 46152, "transcript_chars": 7747}, "timing": {}, "claims": [{"claim": "Unity-gamedev-standards naming conventions were applied (PFB_, SPR_, SO_, SCN_, BGM_, SFX_ prefixes; PascalCase scripts; _camelCase private fields; SCREAMING_SNAKE_CASE constants)", "type": "quality", "verified": true, "evidence": "ImplementationPlanOverview.md Naming Conventions section explicitly lists all these conventions. Implementation detail files consistently use them: PFB_Cat.prefab, SPR_Cat_Idle, SFX_Jump, BGM_Level01, SO_PlayerConfig, SCN_Level01, PLAYER_SPEED constant, _model/_view/_rigidbody private field names in class definitions."}, {"claim": "The skill read the unity-gamedev-standards plugin and applied its constraints (MVC pattern, LateUpdate for camera, Inspector values not overridden in Awake/Start)", "type": "process", "verified": true, "evidence": "Transcript Step 3 confirms reading the unity-gamedev-standards SKILL.md and project-structure.md. ImplementationPlanOverview.md Notes section explicitly cites all three constraints. 01_Player_Implementation.md shows MVC split into PlayerController/PlayerModel/PlayerView classes."}, {"claim": "The game design is internally consistent between design and implementation files", "type": "quality", "verified": true, "evidence": "Constants match across files: PLAYER_SPEED [EXAMPLE: 6.0f] appears in both GameDesignOverview, 01_Player_Design.md, ImplementationPlanOverview.md, and 01_Player_Implementation.md. Fish tier point values and star rating thresholds (50%/80%) are consistent between 02_Collectibles_Design.md and ImplementationPlanOverview.md. Cross-references between files use correct relative paths."}, {"claim": "Detail files include back-links to their parent overview", "type": "quality", "verified": true, "evidence": "01_Player_Design.md opens with '> Part of [GameDesignOverview.md](../GameDesignOverview.md)'. 01_Player_Implementation.md opens with '> Part of [ImplementationPlanOverview.md](../ImplementationPlanOverview.md)'. Both sampled files confirm this pattern."}, {"claim": "5 levels are defined with distinct themes", "type": "factual", "verified": true, "evidence": "GameDesignOverview.md Content Scope Summary lists 5 levels: 'Backyard, Fish Market, Alleyway, Rooftops, Park'. Transcript Step 4 confirms '5 level themes with new elements per level' in 04_LevelContent_Design.md."}], "user_notes_summary": {"uncertainties": [], "needs_review": [], "workarounds": []}, "eval_feedback": {"suggestions": [{"assertion": "All documents are written in English", "reason": "This assertion passes trivially \u2014 any non-empty English-language file would satisfy it. It does not check whether the content is actually meaningful game design documentation rather than placeholder or boilerplate text. Consider replacing with a content-quality assertion, e.g., 'Each document contains specific details about the input game concept (cat protagonist, fish collectibles, dog enemies)' or 'Design documents reflect the specific game parameters provided in the eval prompt'."}, {"assertion": "At least one game design detail file is created in docs_for_ai/game_design/", "reason": "The bar of 'at least one' is easily passed even by a minimal or low-quality execution. The actual output produced 4 design files and 5 implementation files, each with substantive content. A stronger assertion would check that the number of detail files matches the system decomposition described in the overview's File Manifest, or that the content covers the specific systems required by the eval prompt."}, {"reason": "No assertion checks that the detail files are internally coherent or cross-referenced correctly (e.g., that the File Manifest links in the overview actually point to files that exist). The implementation confirmed correct relative-path hyperlinks and back-links, but no eval assertion would have caught broken links or mismatched filenames."}, {"reason": "No assertion checks that the unity-gamedev-standards plugin was actually consulted and its constraints reflected. This was one of the skill's key differentiators (MVC pattern, LateUpdate camera, naming conventions), yet a passing run that ignored the standards plugin would satisfy all 8 assertions."}], "overall": "All 8 assertions pass and the output is genuinely high quality. However, most assertions are structural/existence checks that would pass even for shallow or off-topic outputs. The eval lacks content-quality assertions that verify the documents reflect the specific input (cat/fish/dog platformer) or that platform-specific standards were applied."}}}, {"id": "eval-platformer-design-without_skill-run-1", "prompt": "(No prompt found)", "eval_id": null, "outputs": [{"name": "game_design_document.md", "type": "text", "content": "# Cat & Fish: A 2D Mobile Platformer\n## Game Design Document (GDD)\n\n**Version:** 1.0\n**Date:** 2026-02-28\n**Platform:** Unity Mobile (iOS & Android)\n**Genre:** 2D Side-Scrolling Platformer\n\n---\n\n## 1. Game Overview\n\n### 1.1 Concept\nCat & Fish is a charming 2D side-scrolling platformer for mobile devices. The player controls a cat character navigating colorful environments, collecting fish while avoiding dangerous dogs. The game features 5 progressively challenging levels, pick-up-and-play accessibility, and satisfying movement mechanics optimized for touch input.\n\n### 1.2 Target Audience\n- Age: 8 and up\n- Casual to mid-core mobile gamers\n- Fans of cute animal aesthetics\n- Players who enjoy arcade-style platformers\n\n### 1.3 Unique Selling Points\n- Intuitive one-thumb control scheme for mobile\n- Expressive cat character with fluid animations\n- Variety of fish types with different point values\n- Escalating challenge with distinct dog enemy behaviors\n- Colorful, cartoonish art direction\n\n---\n\n## 2. Gameplay Design\n\n### 2.1 Core Loop\n1. Player navigates a level by running and jumping\n2. Collect fish to earn points and progress toward level completion\n3. Avoid or escape from dog enemies\n4. Reach the end of the level (or collect a required number of fish) to advance\n5. Repeat with increasing difficulty\n\n### 2.2 Win & Fail Conditions\n- **Win:** Collect the required fish quota AND reach the exit portal/goal\n- **Fail:** Getting caught by a dog (touched), falling into a pit/hazard\n- **Retry:** Instant retry button on death, no long load screens\n\n### 2.3 Scoring System\n| Fish Type | Points |\n|-----------|--------|\n| Sardine (common) | 10 |\n| Salmon (uncommon) | 30 |\n| Tuna (rare) | 50 |\n| Golden Fish (bonus) | 100 |\n\n- **Star Rating:** 1\u20133 stars per level based on fish collected and time\n  - 1 Star: Complete level (meet minimum fish quota)\n  - 2 Stars: Collect 75% of all fish in level\n  - 3 Stars: Collect 100% of all fish in level within time limit\n\n---\n\n## 3. Player Character: The Cat\n\n### 3.1 Character Description\n- Name: Nyan (working title)\n- A small, expressive orange tabby cat\n- Large eyes that emote during gameplay (idle, scared, happy)\n- Wears a little scarf (visual personality touch)\n\n### 3.2 Movement Mechanics\n| Action | Description | Control |\n|--------|-------------|---------|\n| Run | Auto-run from left to right; direction can be reversed | Left/Right virtual buttons |\n| Jump | Single jump with variable height | Jump button (hold for higher jump) |\n| Double Jump | Unlocked after Level 2 | Second press of Jump button mid-air |\n| Wall Slide | Slow fall when pressing against a wall | Hold into wall direction |\n| Wall Jump | Jump off walls | Jump while wall sliding |\n\n#### Mobile Control Layout\n- Left half of screen: Left/Right directional buttons (thumb-friendly)\n- Right side: Jump button (large, prominent)\n- Optional swipe gestures as accessibility alternative\n\n### 3.3 Physics Parameters (Design Targets)\n| Parameter | Value (design intent) |\n|-----------|----------------------|\n| Run Speed | 5 units/sec (base), 7 units/sec (sprinting) |\n| Jump Height | ~3.5 platform-units (single), ~5.5 (double) |\n| Gravity Scale | 2.5x (snappy, not floaty) |\n| Coyote Time | 0.1 seconds |\n| Jump Buffer | 0.15 seconds |\n\n**Note:** \"Coyote Time\" allows the player to jump briefly after walking off a ledge; \"Jump Buffer\" queues a jump input slightly before landing. Both improve game feel.\n\n### 3.4 Animations\n- Idle (sitting, tail flick loop)\n- Run (4-legged gallop cycle)\n- Jump (stretch up)\n- Fall (curl/wide eyes)\n- Land (squash)\n- Wall Slide (claws-out slide)\n- Collect Fish (quick happy spin)\n- Hit by Dog (flail, knocked back)\n- Death (star burst, cute)\n\n---\n\n## 4. Fish (Collectibles)\n\n### 4.1 Fish Placement Philosophy\n- Sardines are scattered throughout as the baseline collectible\n- Salmon and Tuna placed in moderately risky locations (over gaps, near dogs)\n- Golden Fish placed in the most challenging or hidden spots\n- Every level has a \"secret\" Golden Fish requiring exploration or precise platforming\n\n### 4.2 Fish Behaviors\n- Static placement (most fish): floating/bobbing in place\n- Moving fish (later levels): fish swimming back and forth on a path\n- Fish jars (bonus): a sealed container the cat must break open for multiple fish inside\n\n### 4.3 Fish Magnet Power-Up\n- Temporary collectible that attracts all nearby fish to the player\n- Lasts 5 seconds\n- Visual: glowing aura around the cat\n\n---\n\n## 5. Enemies: The Dogs\n\n### 5.1 Dog Types\n\n#### Type 1: Poodle Patrol (Levels 1-3)\n- Walks back and forth on a platform\n- Turns around at ledge edges or walls\n- Cannot jump\n- Alert range: 4 units horizontal\n\n#### Type 2: Bulldog Chase (Levels 2-5)\n- Stationary until cat enters alert radius (6 units)\n- Charges in a straight line when alerted\n- Stops at platform edge; cannot fall off\n- Slower but has large body (wider hitbox)\n\n#### Type 3: Terrier Jumper (Levels 3-5)\n- Can jump between platforms\n- Patrols a set vertical and horizontal range\n- Faster than other dogs\n\n#### Type 4: Sheepdog Boss (Level 5 only)\n- Large enemy covering a wide area\n- Throws bones as projectiles\n- Has 3 phase behavior (patrol \u2192 chase \u2192 frantic)\n- Requires avoiding for 30 seconds to clear zone (not defeated, just outlasted)\n\n### 5.2 Dog Encounter Design Principles\n- Dogs should feel threatening but fair\n- Player always has an escape route\n- Dogs do not permanently follow the player across the entire level\n- Alert state is clearly communicated (exclamation mark icon + bark SFX)\n\n---\n\n## 6. Level Design\n\n### 6.1 Level Progression Overview\n\n| Level | Name | Setting | New Mechanic | Dog Types | Fish Quota |\n|-------|------|---------|--------------|-----------|------------|\n| 1 | The Sunny Yard | Suburban backyard | Run & Jump basics | Poodle Patrol | 10/20 fish |\n| 2 | The Rooftop Chase | City rooftops | Double Jump | Poodle + Bulldog | 15/25 fish |\n| 3 | The Rainy Alley | Wet urban alley | Wall Slide & Jump | All basic types | 20/30 fish |\n| 4 | The Haunted Park | Spooky park at night | Moving platforms | All types | 25/35 fish |\n| 5 | The Junkyard Finale | Industrial junkyard | Sheepdog Boss zone | All + Sheepdog | 30/40 fish |\n\n### 6.2 Level Structure (per level)\n- **Length:** ~90\u2013120 seconds to complete at average pace\n- **Layout:** Horizontal scroll, some vertical climbing sections\n- **Checkpoints:** 2 per level (placed after difficult sections)\n- **Exit:** Glowing cat door / portal at the end\n\n### 6.3 Level 1: The Sunny Yard (Detailed Breakdown)\n- **Goal:** Introduce run and jump. Safe, tutorial-style.\n- **Sections:**\n  1. Flat run with spaced platforms \u2014 teaches jumping over gaps\n  2. Short vertical section \u2014 jump up flower pots and fence posts\n  3. First Poodle Patrol \u2014 wide platform, easy to jump over\n  4. Sardine collection zone \u2014 rewarding, safe fish cluster\n  5. Goal: Cat door in a shed wall\n- **Fish count:** 20 Sardines, 0 Salmon, 0 Tuna, 0 Golden\n- **Fish quota to advance:** 10\n\n### 6.4 Level 5: The Junkyard Finale (Detailed Breakdown)\n- **Goal:** Culminate all mechanics. Challenging but fair.\n- **Sections:**\n  1. Obstacle gauntlet \u2014 Terriers + moving platforms\n  2. Bulldog maze \u2014 narrow corridors requiring precise timing\n  3. Hidden Golden Fish zone \u2014 optional, high-risk area\n  4. Sheepdog Boss zone \u2014 30-second endurance section avoiding bone throws\n  5. Final sprint to exit \u2014 escape sequence feel, exciting music change\n- **Fish count:** 15 Sardines, 10 Salmon, 10 Tuna, 5 Golden\n- **Fish quota to advance:** 30\n\n---\n\n## 7. Visual Design\n\n### 7.1 Art Direction\n- **Style:** Cartoon 2D sprite art, bright and saturated\n- **Inspiration:** Early Flash games, Nitrome aesthetic, Neko Atsume charm\n- **Resolution Target:** 1920x1080 base, scaled for mobile screens\n- **Sprite Size:** Player ~64x64 px logical; environments tile at 32x32\n\n### 7.2 Color Palette per Level\n| Level | Primary Color | Mood |\n|-------|--------------|------|\n| 1 | Warm yellows, greens | Cheerful, safe |\n| 2 | Blues, grays, orange sunset | Adventurous |\n| 3 | Dark blues, purple rain | Tense, moody |\n| 4 | Deep purples, oranges, fireflies | Eerie, whimsical |\n| 5 | Browns, rusted metal, sparks | Industrial, dramatic |\n\n### 7.3 UI/HUD\n- Fish counter (top left): icon + current/quota count\n- Score display (top center)\n- Lives/health indicator: 3 fish icons (cat has 3 lives)\n- Touch controls: Semi-transparent, unobtrusive\n- No persistent UI clutter; level name shown only at start\n\n---\n\n## 8. Audio Design\n\n### 8.1 Music\n- Upbeat, looping background tracks per level\n- Level 1: Acoustic/ukulele\n- Level 2: Upbeat synth\n- Level 3: Jazz/blues with rain ambience\n- Level 4: Playful spooky (pizzicato strings, theremin)\n- Level 5: Rock/chase music\n- Boss sequence: High-energy action track\n\n### 8.2 Sound Effects\n- Cat meow on jump (light, not annoying)\n- Fish collection chime (sparkle SFX)\n- Dog bark on alert\n- Dog chase growl (looping)\n- Hit: yelp + knockback\n- Level complete: happy cat purr jingle\n\n### 8.3 Haptic Feedback (Mobile)\n- Light tap: Fish collected\n- Medium pulse: Jump\n- Strong vibration: Hit by dog / death\n\n---\n\n## 9. Progression & Retention\n\n### 9.1 Level Unlock System\n- Levels unlock sequentially (complete Level N to unlock N+1)\n- One-time unlock: No grinding required\n\n### 9.2 Replay Incentives\n- 3-star system encourages replays for perfectionists\n- Total star count displayed on level select screen\n- Potential future: leaderboard scores per level\n\n### 9.3 Metagame (Optional Future Scope)\n- Costume shop: Unlock cat skins with collected stars\n- Gallery: Unlock fish artwork as you collect types\n- These are out of scope for v1.0 but noted for roadmap\n\n---\n\n## 10. Accessibility\n\n- Adjustable touch control size (small/medium/large)\n- Colorblind-friendly fish icons (distinct shapes, not just colors)\n- Option to disable haptic feedback\n- Pause available at any time\n- Checkpoint system reduces punishment for failure\n"}, {"name": "implementation_plan.md", "type": "text", "content": "# Cat & Fish: Unity Implementation Plan\n\n**Version:** 1.0\n**Date:** 2026-02-28\n**Engine:** Unity 2022 LTS\n**Platform:** iOS & Android (Mobile)\n\n---\n\n## 1. Technology Stack\n\n| Category | Technology |\n|----------|------------|\n| Engine | Unity 2022.3 LTS |\n| Language | C# |\n| Rendering | Universal Render Pipeline (URP) 2D |\n| Physics | Unity 2D Physics (Rigidbody2D + Collider2D) |\n| Animation | Unity Animator (Sprite-based) |\n| Audio | Unity Audio Mixer |\n| Input | Unity Input System (New Input System package) |\n| UI | Unity UI Toolkit or uGUI |\n| Version Control | Git + GitHub/GitLab |\n| CI/CD | Unity Cloud Build (or GitHub Actions) |\n\n---\n\n## 2. Project Structure\n\n```\nAssets/\n  _Project/\n    Scripts/\n      Player/\n        PlayerController.cs\n        PlayerAnimator.cs\n        PlayerHealth.cs\n      Enemies/\n        DogBase.cs\n        PoodlePatrol.cs\n        BulldogChase.cs\n        TerrierJumper.cs\n        SheepdogBoss.cs\n      Collectibles/\n        Fish.cs\n        FishMagnet.cs\n        FishSpawner.cs\n      Level/\n        LevelManager.cs\n        Checkpoint.cs\n        LevelExit.cs\n        MovingPlatform.cs\n      UI/\n        HUDController.cs\n        PauseMenu.cs\n        LevelSelectUI.cs\n        GameOverUI.cs\n        LevelCompleteUI.cs\n      GameManagement/\n        GameManager.cs\n        ScoreManager.cs\n        SaveSystem.cs\n        AudioManager.cs\n        InputManager.cs\n    Prefabs/\n      Player/\n      Enemies/\n      Collectibles/\n      UI/\n      Level/\n    Scenes/\n      MainMenu.unity\n      LevelSelect.unity\n      Level_01.unity\n      Level_02.unity\n      Level_03.unity\n      Level_04.unity\n      Level_05.unity\n      GameOver.unity\n    Art/\n      Sprites/\n        Player/\n        Enemies/\n        Collectibles/\n        Environment/\n        UI/\n      Animations/\n      Tilemaps/\n    Audio/\n      Music/\n      SFX/\n    Tilemaps/\n      Level01_Tileset/\n      ...\n    ScriptableObjects/\n      FishData/\n      EnemyData/\n      LevelData/\n```\n\n---\n\n## 3. Core Systems Implementation\n\n### 3.1 Player Controller (`PlayerController.cs`)\n\n**Responsibilities:**\n- Horizontal movement (left/right)\n- Jump (variable height, double jump)\n- Wall slide and wall jump\n- Ground and wall detection via raycasts or overlap checks\n- Coyote time and jump buffering\n\n**Key Implementation Notes:**\n\n```csharp\n// Coyote time implementation sketch\nprivate float coyoteTimeCounter;\nprivate float jumpBufferCounter;\n\nvoid Update()\n{\n    // Coyote time: allow jump briefly after leaving ground\n    if (IsGrounded()) coyoteTimeCounter = coyoteTime;\n    else coyoteTimeCounter -= Time.deltaTime;\n\n    // Jump buffer: queue jump input\n    if (Input.JumpPressed) jumpBufferCounter = jumpBufferTime;\n    else jumpBufferCounter -= Time.deltaTime;\n\n    if (jumpBufferCounter > 0 && coyoteTimeCounter > 0)\n    {\n        PerformJump();\n        jumpBufferCounter = 0;\n    }\n}\n```\n\n**Ground Detection:**\n- Use `Physics2D.BoxCast` downward from player feet\n- Layer mask for \"Ground\" layer\n- Small skin width to avoid false positives\n\n**Wall Detection:**\n- `Physics2D.BoxCast` left and right from player body\n- Wall slide activates when pressing into wall while airborne\n\n### 3.2 Enemy System\n\n**Class Hierarchy:**\n```\nDogBase (MonoBehaviour)\n  \u251c\u2500\u2500 PoodlePatrol\n  \u251c\u2500\u2500 BulldogChase\n  \u251c\u2500\u2500 TerrierJumper\n  \u2514\u2500\u2500 SheepdogBoss\n```\n\n**DogBase responsibilities:**\n- Alert state machine (Idle \u2192 Alert \u2192 Chase \u2192 Return)\n- Player detection radius check (using `Physics2D.OverlapCircle`)\n- On-touch player damage event\n- Abstract `UpdateBehavior()` method for subclasses\n\n**State Machine Pattern:**\n```csharp\npublic enum DogState { Patrol, Alert, Chase, Return }\n\nprotected DogState currentState;\n\nvoid Update()\n{\n    switch (currentState)\n    {\n        case DogState.Patrol: Patrol(); break;\n        case DogState.Alert: Alert(); break;\n        case DogState.Chase: Chase(); break;\n        case DogState.Return: ReturnToStart(); break;\n    }\n    DetectPlayer();\n}\n```\n\n**PoodlePatrol specifics:**\n- Moves between two patrol points (serialized in Inspector)\n- Flips sprite direction at each point\n- Never leaves platform (edge detection raycast)\n\n**BulldogChase specifics:**\n- Stationary until player enters radius\n- Charges in straight line (no pathfinding needed)\n- Stops at platform edge (downward raycast check)\n\n**TerrierJumper specifics:**\n- Simple patrol + jump logic\n- Uses Rigidbody2D.AddForce for jumps\n- Navigates between predefined waypoints\n\n**SheepdogBoss specifics:**\n- Phase-based behavior (timed phases, not HP-based)\n- Bone projectile: instantiate `BonePrefab`, apply velocity toward player position at fire time\n- 30-second endurance timer triggers level exit unlock\n\n### 3.3 Fish Collectible System\n\n**Fish.cs:**\n- ScriptableObject data reference (`FishData`: type, points, sprite)\n- `OnTriggerEnter2D` detection with player layer\n- Trigger `ScoreManager.AddScore(points)`\n- Trigger `LevelManager.OnFishCollected()`\n- Play collect animation (tween scale to 0, then destroy)\n- Play SFX via AudioManager\n\n**FishMagnet.cs (power-up):**\n- OnPickup: Start coroutine for 5-second duration\n- During duration: Find all Fish in radius, move them toward player with `Vector2.MoveTowards`\n- OnExpiry: Remove magnet effect\n\n**LevelManager fish tracking:**\n```csharp\nprivate int totalFish;\nprivate int collectedFish;\nprivate int requiredFish;\n\npublic void OnFishCollected()\n{\n    collectedFish++;\n    HUDController.UpdateFishCount(collectedFish, requiredFish);\n    if (collectedFish >= requiredFish) EnableLevelExit();\n}\n```\n\n### 3.4 Level Manager (`LevelManager.cs`)\n\n**Responsibilities:**\n- Initialize level (fish count, required quota)\n- Manage checkpoints\n- Track level state (playing, paused, complete, failed)\n- Handle player death \u2192 respawn at last checkpoint\n- Handle level complete \u2192 show summary screen\n- Calculate star rating\n\n**Checkpoint system:**\n```csharp\n// Checkpoint.cs\nvoid OnTriggerEnter2D(Collider2D other)\n{\n    if (other.CompareTag(\"Player\"))\n    {\n        LevelManager.Instance.SetCheckpoint(this.transform.position);\n        // Visual: animate checkpoint flag raising\n    }\n}\n```\n\n**Star Rating Calculation:**\n```csharp\nint CalculateStars(int collected, int total, float completionTime, float targetTime)\n{\n    if (collected == total && completionTime <= targetTime) return 3;\n    if ((float)collected / total >= 0.75f) return 2;\n    return 1; // Minimum: completed level at all\n}\n```\n\n### 3.5 Input System (Mobile)\n\n**Approach:** Unity's New Input System with on-screen UI buttons\n\n**InputManager.cs:**\n- Reads from virtual buttons mapped to Input Actions\n- Exposes: `MoveInput (float -1 to 1)`, `JumpPressed (bool)`, `JumpHeld (bool)`\n\n**On-Screen Controls:**\n- Left area: Two buttons (Left arrow, Right arrow) using `OnScreenButton` or custom UI\n- Right area: Large Jump button\n- All buttons semi-transparent to minimize screen obstruction\n- Touch areas sized 80px+ for comfortable thumb use\n\n**Alternative input for testing:**\n- Keyboard WASD / Arrow keys + Space for editor testing\n- Handled automatically by Input System action bindings\n\n### 3.6 Save System (`SaveSystem.cs`)\n\n**Save Data Structure:**\n```csharp\n[Serializable]\npublic class SaveData\n{\n    public int highestUnlockedLevel;\n    public int[] levelStars; // index 0-4 for levels 1-5\n    public int[] levelHighScores;\n}\n```\n\n**Storage:** `PlayerPrefs` with JSON serialization (via `JsonUtility`)\n- Simple, sufficient for this scope\n- Alternative for larger scope: `Application.persistentDataPath` + file write\n\n**Save triggers:**\n- On level complete\n- On returning to main menu\n- Auto-save every 60 seconds during play\n\n### 3.7 Audio Manager (`AudioManager.cs`)\n\n**Singleton pattern**\n\n**Features:**\n- Play/stop music tracks with fade transitions (Coroutine + AudioSource volume lerp)\n- Play one-shot SFX\n- Global volume controls (Music volume, SFX volume) persisted in PlayerPrefs\n- Supports 2D audio (mobile game, no spatial audio needed)\n\n---\n\n## 4. Scene Setup\n\n### 4.1 Each Level Scene Contains:\n- Tilemap GameObjects (Background, Ground, Foreground layers)\n- Player spawn point (empty GameObject with tag \"SpawnPoint\")\n- Camera: Cinemachine Virtual Camera following player with horizontal dampening\n- Fish prefab instances placed via Scene editor\n- Enemy prefab instances with patrol points configured\n- Checkpoint triggers\n- Level exit trigger\n- UI Canvas (HUD overlay)\n- Audio Source for level music\n\n### 4.2 Camera Setup (Cinemachine)\n- Follow target: Player transform\n- Confiner 2D: Set to level bounding box collider\n- Horizontal deadzone: small (player can move slightly before camera follows)\n- Vertical follow: lookahead enabled (camera peeks in movement direction)\n- Orthographic size: tuned per level (e.g., 6-7 units for mobile aspect ratios)\n\n### 4.3 Tilemap Layers\n| Layer | Z-Order | Purpose |\n|-------|---------|---------|\n| Background | -2 | Non-interactive scenery |\n| Background Detail | -1 | Parallax elements |\n| Ground | 0 | Interactive platforms (has TilemapCollider2D) |\n| Foreground | 1 | In-front-of-player decorative elements |\n\n---\n\n## 5. Development Milestones\n\n### Phase 1: Prototype (Week 1-2)\n- [ ] Unity project setup, URP 2D configured\n- [ ] Basic PlayerController (run, jump, ground detection)\n- [ ] Placeholder sprites (colored rectangles)\n- [ ] One flat test scene\n- [ ] Collectible pickup trigger\n- [ ] Basic enemy patrol behavior\n\n**Milestone Criteria:** Cat can move, jump, collect items, and be \"caught\" by a patrolling rectangle enemy.\n\n### Phase 2: Core Systems (Week 3-4)\n- [ ] All player movement mechanics (double jump, wall slide, wall jump)\n- [ ] All dog enemy types implemented\n- [ ] Fish variety with ScriptableObjects\n- [ ] LevelManager: fish quota, win/fail state\n- [ ] Checkpoint system\n- [ ] SaveSystem (PlayerPrefs)\n- [ ] Input System: virtual mobile buttons working\n- [ ] HUD: fish count, score display\n\n**Milestone Criteria:** Full gameplay loop playable with placeholder art. Mobile touch controls functional.\n\n### Phase 3: Content (Week 5-7)\n- [ ] All 5 levels designed and built in Unity (tilemap layout)\n- [ ] Fish placed in all levels\n- [ ] Enemy instances placed and configured\n- [ ] Moving platforms in Level 4\n- [ ] Sheepdog Boss sequence in Level 5\n- [ ] Level complete / game over screens\n\n**Milestone Criteria:** All 5 levels playable start to finish with placeholder art.\n\n### Phase 4: Art & Audio Integration (Week 8-10)\n- [ ] Final player sprite sheet and Animator setup\n- [ ] All enemy sprite sheets and Animators\n- [ ] Fish sprites and collect animations\n- [ ] Tileset art for all 5 level themes\n- [ ] UI art assets\n- [ ] Music tracks integrated\n- [ ] SFX integrated\n- [ ] Haptic feedback implemented\n\n**Milestone Criteria:** Game looks and sounds like the final product.\n\n### Phase 5: Polish & QA (Week 11-12)\n- [ ] Cinemachine camera tuning\n- [ ] Game feel tuning (coyote time, jump feel, gravity tweaks)\n- [ ] Difficulty balancing (enemy speed, alert radius, fish placement)\n- [ ] Performance profiling on target devices (aim: 60fps on mid-range phones)\n- [ ] Bug fixing\n- [ ] Accessibility options (control size, haptics toggle)\n- [ ] App store metadata preparation (icon, screenshots, description)\n\n**Milestone Criteria:** Game passes internal QA playthrough. No crash bugs. Runs at 60fps on test devices.\n\n### Phase 6: Release (Week 13-14)\n- [ ] Unity Cloud Build: iOS & Android builds\n- [ ] TestFlight / Play Store internal track testing\n- [ ] Final bug fixes from beta feedback\n- [ ] App store submission\n- [ ] Marketing material (GIF/video of gameplay)\n\n---\n\n## 6. Performance Targets & Optimization\n\n### 6.1 Targets\n- 60 FPS on mid-range devices (iPhone 11, Android with Snapdragon 660 equivalent)\n- Max draw calls per frame: ~50\n- Max memory usage: ~250 MB\n\n### 6.2 Optimization Strategies\n- **Sprite Atlasing:** Pack all sprites per level into sprite atlases to reduce draw calls\n- **Object Pooling:** Fish and bone projectiles use object pools (avoid Instantiate/Destroy each frame)\n- **Tilemap batching:** URP handles tilemap batching automatically; verify in Frame Debugger\n- **Audio compression:** Music as Ogg Vorbis (streaming), SFX as compressed PCM\n- **Physics layers:** Limit collision matrix \u2014 enemies don't collide with each other, only with ground and player\n- **Camera culling:** Objects outside camera view automatically culled; trust Unity's frustum culling\n\n### 6.3 Object Pool Example\n\n```csharp\n// Simple object pool for bone projectiles\npublic class BonePool : MonoBehaviour\n{\n    [SerializeField] private GameObject bonePrefab;\n    [SerializeField] private int poolSize = 10;\n    private Queue<GameObject> pool = new Queue<GameObject>();\n\n    void Start()\n    {\n        for (int i = 0; i < poolSize; i++)\n        {\n            var bone = Instantiate(bonePrefab);\n            bone.SetActive(false);\n            pool.Enqueue(bone);\n        }\n    }\n\n    public GameObject GetBone()\n    {\n        if (pool.Count > 0)\n        {\n            var bone = pool.Dequeue();\n            bone.SetActive(true);\n            return bone;\n        }\n        return Instantiate(bonePrefab); // fallback\n    }\n\n    public void ReturnBone(GameObject bone)\n    {\n        bone.SetActive(false);\n        pool.Enqueue(bone);\n    }\n}\n```\n\n---\n\n## 7. ScriptableObject Data Design\n\n### FishData (ScriptableObject)\n```csharp\n[CreateAssetMenu(menuName = \"CatFish/FishData\")]\npublic class FishData : ScriptableObject\n{\n    public string fishName;\n    public FishType fishType; // Sardine, Salmon, Tuna, Golden\n    public int pointValue;\n    public Sprite sprite;\n    public AudioClip collectSound;\n}\n```\n\n### EnemyData (ScriptableObject)\n```csharp\n[CreateAssetMenu(menuName = \"CatFish/EnemyData\")]\npublic class EnemyData : ScriptableObject\n{\n    public string enemyName;\n    public float moveSpeed;\n    public float alertRadius;\n    public float chaseSpeed;\n    public Sprite[] sprites;\n}\n```\n\n### LevelData (ScriptableObject)\n```csharp\n[CreateAssetMenu(menuName = \"CatFish/LevelData\")]\npublic class LevelData : ScriptableObject\n{\n    public string levelName;\n    public int levelIndex;\n    public int totalFish;\n    public int requiredFish;\n    public float targetCompletionTime; // for 3-star rating\n    public string sceneName;\n}\n```\n\n---\n\n## 8. Testing Strategy\n\n### 8.1 Unit Tests (Unity Test Framework)\n- SaveSystem: Save and load data integrity\n- ScoreManager: Score calculation and star rating\n- Fish quota logic: Win condition triggers at correct count\n\n### 8.2 Play Mode Tests\n- Player can traverse each level without clipping through geometry\n- All fish collectible triggers fire correctly\n- Enemy state transitions work correctly\n\n### 8.3 Manual QA Checklist (per level)\n- [ ] Level loads without errors\n- [ ] All fish are collectable\n- [ ] Minimum fish quota triggers exit unlock\n- [ ] All enemies behave as designed\n- [ ] No geometry gaps player can fall through\n- [ ] Checkpoint saves position correctly\n- [ ] Level complete screen shows correct star rating\n- [ ] Touch controls responsive (test on physical device)\n- [ ] No framerate drops during busy scenes\n\n### 8.4 Device Testing Matrix\n| Device | OS | Priority |\n|--------|----|----------|\n| iPhone 15 | iOS 17 | High |\n| iPhone 11 | iOS 16 | High |\n| Samsung Galaxy S21 | Android 13 | High |\n| Mid-range Android (e.g., Pixel 5a) | Android 12 | Medium |\n| iPad Air | iPadOS 17 | Low (verify layout) |\n\n---\n\n## 9. Build & Deployment\n\n### 9.1 Unity Build Settings\n- **iOS:** Target minimum iOS 14.0, ARM64 architecture\n- **Android:** Minimum API Level 24 (Android 7.0), IL2CPP scripting backend, ARM64 + ARMv7\n- **Orientation:** Landscape only (locked)\n\n### 9.2 Build Variants\n| Variant | Purpose |\n|---------|---------|\n| Development | Debug logs, Unity Profiler enabled |\n| Staging | No debug logs, ad placeholder |\n| Release | Fully optimized, store-ready |\n\n### 9.3 Build Pipeline (GitHub Actions or Unity Cloud Build)\n1. Trigger on `main` branch push\n2. Run Unity Test Framework tests\n3. Build iOS (requires macOS runner + Xcode)\n4. Build Android (APK + AAB)\n5. Upload artifacts to staging\n6. Notify team on success/failure\n\n---\n\n## 10. Risks & Mitigations\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|-----------|\n| Touch controls feel imprecise | Medium | High | Early prototype on physical device; adjust button sizes and layout iteratively |\n| Level 5 boss too hard for casual players | Medium | Medium | Extensive playtesting; add 3-phase telegraphing; adjustable window |\n| Art scope exceeds timeline | Medium | High | Use placeholder art until Phase 4; art can be scope-reduced |\n| Performance issues on older Android | Low | Medium | Profile early (Phase 2) not just at end |\n| App store rejection | Low | High | Follow App Store / Play Store guidelines from day 1; no third-party SDKs that cause issues |\n"}], "grading": {"expectations": [{"text": "A docs_for_ai/ directory is created with proper subdirectories (game_design/ and implementation/)", "passed": false, "evidence": "The outputs directory contains only: game_design_document.md, implementation_plan.md, metrics.json, transcript.md. No docs_for_ai/ directory was created, and no subdirectories game_design/ or implementation/ exist anywhere in the outputs."}, {"text": "GameDesignOverview.md is created at docs_for_ai/GameDesignOverview.md", "passed": false, "evidence": "No docs_for_ai/ directory exists. The executor created game_design_document.md directly in the outputs/ directory. The required file path docs_for_ai/GameDesignOverview.md does not exist."}, {"text": "ImplementationPlanOverview.md is created at docs_for_ai/ImplementationPlanOverview.md", "passed": false, "evidence": "No docs_for_ai/ directory exists. The executor created implementation_plan.md directly in the outputs/ directory. The required file path docs_for_ai/ImplementationPlanOverview.md does not exist."}, {"text": "All documents are written in English", "passed": true, "evidence": "Both game_design_document.md and implementation_plan.md are written entirely in English. Sample from game_design_document.md: 'Cat & Fish is a charming 2D side-scrolling platformer for mobile devices.' Sample from implementation_plan.md: 'Unity 2022.3 LTS ... Universal Render Pipeline (URP) 2D'. No non-English content found in either document."}, {"text": "Variable values are marked with [EXAMPLE: value] notation", "passed": false, "evidence": "Neither document uses [EXAMPLE: value] notation. Values are stated as concrete facts throughout. Examples: 'Run Speed | 5 units/sec (base), 7 units/sec (sprinting)', 'Coyote Time | 0.1 seconds', 'Jump Buffer | 0.15 seconds'. No bracketed example notation appears anywhere in either document."}, {"text": "The documents include a File Manifest section listing all detail files", "passed": false, "evidence": "Neither game_design_document.md nor implementation_plan.md contains a 'File Manifest' section or any equivalent listing of detail files. The GDD has 10 sections (Game Overview, Gameplay Design, Player Character, Fish, Enemies, Level Design, Visual Design, Audio Design, Progression & Retention, Accessibility); none is a file manifest. The implementation plan similarly has no file manifest section."}, {"text": "At least one game design detail file is created in docs_for_ai/game_design/", "passed": false, "evidence": "No docs_for_ai/game_design/ directory exists. The outputs directory contains only flat files: game_design_document.md, implementation_plan.md, metrics.json, transcript.md. No detail files were created in any subdirectory."}, {"text": "At least one implementation detail file is created in docs_for_ai/implementation/", "passed": false, "evidence": "No docs_for_ai/implementation/ directory exists. The outputs directory contains only flat files: game_design_document.md, implementation_plan.md, metrics.json, transcript.md. No detail files were created in any subdirectory."}], "summary": {"passed": 1, "failed": 7, "total": 8, "pass_rate": 0.125}, "execution_metrics": {"tool_calls": {}, "total_tool_calls": null, "total_steps": 5, "errors_encountered": 0, "output_chars": 27593, "transcript_chars": 3348}, "timing": {}, "claims": [{"claim": "Created a comprehensive GDD covering game overview, gameplay loop, player mechanics, fish collectibles, 4 dog enemy types, 5 levels, visual design, audio design, progression and accessibility", "type": "quality", "verified": true, "evidence": "game_design_document.md contains all 10 sections as claimed. Level design table shows all 5 levels with settings, new mechanics, dog types, and fish quotas. Sections 3-5 detail player character (Nyan), fish types, and 4 enemy types (Poodle Patrol, Bulldog Chase, Terrier Jumper, Sheepdog Boss)."}, {"claim": "Created implementation plan using Unity 2022 LTS, URP 2D, New Input System, Cinemachine", "type": "factual", "verified": true, "evidence": "implementation_plan.md Section 1 technology stack table explicitly lists Unity 2022.3 LTS, Universal Render Pipeline (URP) 2D, Unity Input System (New Input System package). Cinemachine is referenced in Section 4.2 Camera Setup."}, {"claim": "Implementation plan includes C# code sketches for core systems", "type": "factual", "verified": true, "evidence": "implementation_plan.md contains multiple C# code snippets: coyote time/jump buffer implementation (Section 3.1), DogState enum and switch statement (Section 3.2), fish collection tracking (Section 3.3), checkpoint trigger (Section 3.4), star rating calculation (Section 3.4), BonePool object pool (Section 6.3), and three ScriptableObject class definitions (Section 7)."}, {"claim": "14-week development timeline across 6 phases", "type": "factual", "verified": true, "evidence": "implementation_plan.md Section 5 shows 6 development phases: Phase 1 (Week 1-2), Phase 2 (Week 3-4), Phase 3 (Week 5-7), Phase 4 (Week 8-10), Phase 5 (Week 11-12), Phase 6 (Week 13-14). Total span is 14 weeks as claimed in metrics.json."}, {"claim": "No errors encountered (errors_encountered: 0)", "type": "process", "verified": true, "evidence": "metrics.json reports errors_encountered: 0. Transcript confirms smooth execution across 5 steps with no error recovery or retry behavior noted."}, {"claim": "Output represents a baseline for comparison against the design-workflow skill", "type": "quality", "verified": true, "evidence": "The executor correctly produced two comprehensive documents without using the skill, providing a valid baseline. However, the baseline does not produce the docs_for_ai/ structured format that the skill would be expected to generate, which is precisely why this is the 'without_skill' run."}], "user_notes_summary": {}, "eval_feedback": {"suggestions": [{"assertion": "All documents are written in English", "reason": "This assertion would pass for any text-based output including placeholder text or trivially short documents. It adds no meaningful discriminating signal. Consider removing it or replacing it with a more substantive content quality check."}, {"reason": "No assertion checks the content quality or completeness of the game design itself \u2014 e.g., whether all 5 levels are designed, whether the cat/fish/dog mechanics are actually addressed, or whether the implementation plan is technically coherent. The skill is being evaluated only on structural format (docs_for_ai/ layout), not on whether it produces better content than a baseline run. Adding a content quality assertion would make the eval more meaningful."}, {"reason": "The [EXAMPLE: value] notation assertion (expectation 5) is testing a very specific formatting convention. It would be worth clarifying in the eval setup what the skill's prompt explicitly instructs about this notation, so it's clear whether a FAIL here means the skill failed to follow its own instructions or the eval expectation is misaligned with what the skill actually specifies."}, {"reason": "Expectations 7 and 8 check for at least one detail file in each subdirectory, but no assertion checks the *content* of those detail files. A skill that creates empty or trivial detail files would pass these assertions while failing to produce useful documentation."}], "overall": "The evals are well-targeted at verifying the docs_for_ai/ structured format that distinguishes the skill run from the without-skill baseline. The without-skill run fails 7 of 8 assertions as expected, which is the correct discriminating outcome. The one passing assertion (English language) is trivially satisfied and provides no signal. Consider adding at least one content-quality assertion to make the eval more robust."}}}], "previous_feedback": {}, "previous_outputs": {}, "benchmark": {"metadata": {"skill_name": "design-workflow", "skill_path": "plugins/kn-gamedev-workflow/skills/design-workflow", "executor_model": "<model-name>", "analyzer_model": "<model-name>", "timestamp": "2026-02-28T08:26:19Z", "evals_run": [1], "runs_per_configuration": 3}, "runs": [{"eval_id": 1, "configuration": "with_skill", "run_number": 1, "result": {"pass_rate": 1.0, "passed": 8, "failed": 0, "total": 8, "time_seconds": 0.0, "tokens": 46152, "tool_calls": null, "errors": 0}, "expectations": [{"text": "A docs_for_ai/ directory is created with proper subdirectories (game_design/ and implementation/)", "passed": true, "evidence": "Directory listing confirms: outputs/docs_for_ai/ contains game_design/ and implementation/ subdirectories. Transcript Step 5 explicitly states: 'Created outputs/docs_for_ai/', 'Created outputs/docs_for_ai/game_design/', 'Created outputs/docs_for_ai/implementation/'."}, {"text": "GameDesignOverview.md is created at docs_for_ai/GameDesignOverview.md", "passed": true, "evidence": "File exists at outputs/docs_for_ai/GameDesignOverview.md (4124 bytes). Content is substantive: full game design document for 'Purrfect Run' with 8 sections including Game Overview, Core Concept, World and Setting, Design File Manifest, Cross-Cutting Concerns, Technical Requirements, Content Scope Summary, and Notes."}, {"text": "ImplementationPlanOverview.md is created at docs_for_ai/ImplementationPlanOverview.md", "passed": true, "evidence": "File exists at outputs/docs_for_ai/ImplementationPlanOverview.md (6212 bytes). Content is substantive: includes Project Structure, Phase Summary, Implementation File Manifest, Key Constants, Dependencies, and Testing Strategy sections."}, {"text": "All documents are written in English", "passed": true, "evidence": "All files read (GameDesignOverview.md, ImplementationPlanOverview.md, 01_Player_Design.md, 02_Collectibles_Design.md, 01_Player_Implementation.md) are written entirely in English. No non-English text found in any sampled document."}, {"text": "Variable values are marked with [EXAMPLE: value] notation", "passed": true, "evidence": "Multiple instances of [EXAMPLE:] notation confirmed across files. In GameDesignOverview.md: '[EXAMPLE: 30-60 minutes]', '[EXAMPLE: 60 FPS]', '[EXAMPLE: < 3 seconds]', '[EXAMPLE: 10-20 per level]'. In ImplementationPlanOverview.md: '[EXAMPLE: 6.0f]', '[EXAMPLE: 12.0f]', '[EXAMPLE: 0.12f]', etc. In 01_Player_Design.md: '[EXAMPLE: 6.0 units/sec]', '[EXAMPLE: 12.0 units]', '[EXAMPLE: 0.12 seconds]'."}, {"text": "The documents include a File Manifest section listing all detail files", "passed": true, "evidence": "GameDesignOverview.md has '## 4. Design File Manifest' table listing all 4 design detail files with filename, domain, and description. ImplementationPlanOverview.md has '## 3. Implementation File Manifest' table listing all 5 implementation detail files. Both manifests use markdown table format with hyperlinks to the referenced files."}, {"text": "At least one game design detail file is created in docs_for_ai/game_design/", "passed": true, "evidence": "Four game design detail files confirmed in docs_for_ai/game_design/: 01_Player_Design.md (2735 bytes), 02_Collectibles_Design.md (2547 bytes), 03_Enemies_Design.md (2865 bytes), 04_LevelContent_Design.md (2996 bytes). Sampled files contain substantive content with Mechanics, Entities, Player Actions, Progression, and Dependencies sections."}, {"text": "At least one implementation detail file is created in docs_for_ai/implementation/", "passed": true, "evidence": "Five implementation detail files confirmed in docs_for_ai/implementation/: 01_Player_Implementation.md (5294 bytes), 02_Collectibles_Implementation.md (4393 bytes), 03_Enemies_Implementation.md (4763 bytes), 04_LevelContent_Implementation.md (5299 bytes), 05_UIAndPolish_Implementation.md (4924 bytes). Sampled 01_Player_Implementation.md contains Architecture (class definitions with properties and methods), State Management diagram, Tasks, System-Specific Constants, Asset Requirements, and Dependencies sections."}], "notes": []}, {"eval_id": 1, "configuration": "without_skill", "run_number": 1, "result": {"pass_rate": 0.125, "passed": 1, "failed": 7, "total": 8, "time_seconds": 0.0, "tokens": 27593, "tool_calls": null, "errors": 0}, "expectations": [{"text": "A docs_for_ai/ directory is created with proper subdirectories (game_design/ and implementation/)", "passed": false, "evidence": "The outputs directory contains only: game_design_document.md, implementation_plan.md, metrics.json, transcript.md. No docs_for_ai/ directory was created, and no subdirectories game_design/ or implementation/ exist anywhere in the outputs."}, {"text": "GameDesignOverview.md is created at docs_for_ai/GameDesignOverview.md", "passed": false, "evidence": "No docs_for_ai/ directory exists. The executor created game_design_document.md directly in the outputs/ directory. The required file path docs_for_ai/GameDesignOverview.md does not exist."}, {"text": "ImplementationPlanOverview.md is created at docs_for_ai/ImplementationPlanOverview.md", "passed": false, "evidence": "No docs_for_ai/ directory exists. The executor created implementation_plan.md directly in the outputs/ directory. The required file path docs_for_ai/ImplementationPlanOverview.md does not exist."}, {"text": "All documents are written in English", "passed": true, "evidence": "Both game_design_document.md and implementation_plan.md are written entirely in English. Sample from game_design_document.md: 'Cat & Fish is a charming 2D side-scrolling platformer for mobile devices.' Sample from implementation_plan.md: 'Unity 2022.3 LTS ... Universal Render Pipeline (URP) 2D'. No non-English content found in either document."}, {"text": "Variable values are marked with [EXAMPLE: value] notation", "passed": false, "evidence": "Neither document uses [EXAMPLE: value] notation. Values are stated as concrete facts throughout. Examples: 'Run Speed | 5 units/sec (base), 7 units/sec (sprinting)', 'Coyote Time | 0.1 seconds', 'Jump Buffer | 0.15 seconds'. No bracketed example notation appears anywhere in either document."}, {"text": "The documents include a File Manifest section listing all detail files", "passed": false, "evidence": "Neither game_design_document.md nor implementation_plan.md contains a 'File Manifest' section or any equivalent listing of detail files. The GDD has 10 sections (Game Overview, Gameplay Design, Player Character, Fish, Enemies, Level Design, Visual Design, Audio Design, Progression & Retention, Accessibility); none is a file manifest. The implementation plan similarly has no file manifest section."}, {"text": "At least one game design detail file is created in docs_for_ai/game_design/", "passed": false, "evidence": "No docs_for_ai/game_design/ directory exists. The outputs directory contains only flat files: game_design_document.md, implementation_plan.md, metrics.json, transcript.md. No detail files were created in any subdirectory."}, {"text": "At least one implementation detail file is created in docs_for_ai/implementation/", "passed": false, "evidence": "No docs_for_ai/implementation/ directory exists. The outputs directory contains only flat files: game_design_document.md, implementation_plan.md, metrics.json, transcript.md. No detail files were created in any subdirectory."}], "notes": []}], "run_summary": {"with_skill": {"pass_rate": {"mean": 1.0, "stddev": 0.0, "min": 1.0, "max": 1.0}, "time_seconds": {"mean": 0.0, "stddev": 0.0, "min": 0.0, "max": 0.0}, "tokens": {"mean": 46152.0, "stddev": 0.0, "min": 46152, "max": 46152}}, "without_skill": {"pass_rate": {"mean": 0.125, "stddev": 0.0, "min": 0.125, "max": 0.125}, "time_seconds": {"mean": 0.0, "stddev": 0.0, "min": 0.0, "max": 0.0}, "tokens": {"mean": 27593.0, "stddev": 0.0, "min": 27593, "max": 27593}}, "delta": {"pass_rate": "+0.88", "time_seconds": "+0.0", "tokens": "+18559"}}, "notes": []}};

    // ---- State ----
    let feedbackMap = {};  // run_id -> feedback text
    let currentIndex = 0;
    let visitedRuns = new Set();

    // ---- Init ----
    async function init() {
      // Load saved feedback from server  but only if this isn't a fresh
      // iteration (indicated by previous_feedback being present). When
      // previous feedback exists, the feedback.json on disk is stale from
      // the prior iteration and should not pre-fill the textareas.
      const hasPrevious = Object.keys(EMBEDDED_DATA.previous_feedback || {}).length > 0
        || Object.keys(EMBEDDED_DATA.previous_outputs || {}).length > 0;
      if (!hasPrevious) {
        try {
          const resp = await fetch("/api/feedback");
          const data = await resp.json();
          if (data.reviews) {
            for (const r of data.reviews) feedbackMap[r.run_id] = r.feedback;
          }
        } catch { /* first run, no feedback yet */ }
      }

      document.getElementById("skill-name").textContent = EMBEDDED_DATA.skill_name;
      showRun(0);

      // Wire up feedback auto-save
      const textarea = document.getElementById("feedback");
      let saveTimeout = null;
      textarea.addEventListener("input", () => {
        clearTimeout(saveTimeout);
        document.getElementById("feedback-status").textContent = "";
        saveTimeout = setTimeout(() => saveCurrentFeedback(), 800);
      });
    }

    // ---- Navigation ----
    function navigate(delta) {
      const newIndex = currentIndex + delta;
      if (newIndex >= 0 && newIndex < EMBEDDED_DATA.runs.length) {
        saveCurrentFeedback();
        showRun(newIndex);
      }
    }

    function updateNavButtons() {
      document.getElementById("prev-btn").disabled = currentIndex === 0;
      document.getElementById("next-btn").disabled =
        currentIndex === EMBEDDED_DATA.runs.length - 1;
    }

    // ---- Show a run ----
    function showRun(index) {
      currentIndex = index;
      const run = EMBEDDED_DATA.runs[index];

      // Progress
      document.getElementById("progress").textContent =
        `${index + 1} of ${EMBEDDED_DATA.runs.length}`;

      // Prompt
      document.getElementById("prompt-text").textContent = run.prompt;

      // Config badge
      const badge = document.getElementById("config-badge");
      const configMatch = run.id.match(/(with_skill|without_skill|new_skill|old_skill)/);
      if (configMatch) {
        const config = configMatch[1];
        const isBaseline = config === "without_skill" || config === "old_skill";
        badge.textContent = config.replace(/_/g, " ");
        badge.className = "config-badge " + (isBaseline ? "config-baseline" : "config-primary");
        badge.style.display = "inline-block";
      } else {
        badge.style.display = "none";
      }

      // Outputs
      renderOutputs(run);

      // Previous outputs
      renderPrevOutputs(run);

      // Grades
      renderGrades(run);

      // Previous feedback
      const prevFb = (EMBEDDED_DATA.previous_feedback || {})[run.id];
      const prevEl = document.getElementById("prev-feedback");
      if (prevFb) {
        document.getElementById("prev-feedback-text").textContent = prevFb;
        prevEl.style.display = "block";
      } else {
        prevEl.style.display = "none";
      }

      // Feedback
      document.getElementById("feedback").value = feedbackMap[run.id] || "";
      document.getElementById("feedback-status").textContent = "";

      updateNavButtons();

      // Track visited runs and promote done button when all visited
      visitedRuns.add(index);
      const doneBtn = document.getElementById("done-btn");
      if (visitedRuns.size >= EMBEDDED_DATA.runs.length) {
        doneBtn.classList.add("ready");
      }

      // Scroll main content to top
      document.querySelector(".main").scrollTop = 0;
    }

    // ---- Render outputs ----
    function renderOutputs(run) {
      const container = document.getElementById("outputs-body");
      container.innerHTML = "";

      const outputs = run.outputs || [];
      if (outputs.length === 0) {
        container.innerHTML = '<div class="empty-state">No output files</div>';
        return;
      }

      for (const file of outputs) {
        const fileDiv = document.createElement("div");
        fileDiv.className = "output-file";

        // Always show file header with download link
        const header = document.createElement("div");
        header.className = "output-file-header";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = file.name;
        header.appendChild(nameSpan);
        const dlBtn = document.createElement("a");
        dlBtn.className = "dl-btn";
        dlBtn.textContent = "Download";
        dlBtn.download = file.name;
        dlBtn.href = getDownloadUri(file);
        header.appendChild(dlBtn);
        fileDiv.appendChild(header);

        const content = document.createElement("div");
        content.className = "output-file-content";

        if (file.type === "text") {
          const pre = document.createElement("pre");
          pre.textContent = file.content;
          content.appendChild(pre);
        } else if (file.type === "image") {
          const img = document.createElement("img");
          img.src = file.data_uri;
          img.alt = file.name;
          content.appendChild(img);
        } else if (file.type === "pdf") {
          const iframe = document.createElement("iframe");
          iframe.src = file.data_uri;
          content.appendChild(iframe);
        } else if (file.type === "xlsx") {
          renderXlsx(content, file.data_b64);
        } else if (file.type === "binary") {
          const a = document.createElement("a");
          a.className = "download-link";
          a.href = file.data_uri;
          a.download = file.name;
          a.textContent = "Download " + file.name;
          content.appendChild(a);
        } else if (file.type === "error") {
          const pre = document.createElement("pre");
          pre.textContent = file.content;
          pre.style.color = "var(--red)";
          content.appendChild(pre);
        }

        fileDiv.appendChild(content);
        container.appendChild(fileDiv);
      }
    }

    // ---- XLSX rendering via SheetJS ----
    function renderXlsx(container, b64Data) {
      try {
        const raw = Uint8Array.from(atob(b64Data), c => c.charCodeAt(0));
        const wb = XLSX.read(raw, { type: "array" });

        for (let i = 0; i < wb.SheetNames.length; i++) {
          const sheetName = wb.SheetNames[i];
          const ws = wb.Sheets[sheetName];

          if (wb.SheetNames.length > 1) {
            const sheetLabel = document.createElement("div");
            sheetLabel.style.cssText =
              "font-weight:600; font-size:0.8rem; color:#b0aea5; margin-top:0.5rem; margin-bottom:0.25rem;";
            sheetLabel.textContent = "Sheet: " + sheetName;
            container.appendChild(sheetLabel);
          }

          const htmlStr = XLSX.utils.sheet_to_html(ws, { editable: false });
          const wrapper = document.createElement("div");
          wrapper.innerHTML = htmlStr;
          container.appendChild(wrapper);
        }
      } catch (err) {
        container.textContent = "Error rendering spreadsheet: " + err.message;
      }
    }

    // ---- Grades ----
    function renderGrades(run) {
      const section = document.getElementById("grades-section");
      const content = document.getElementById("grades-content");

      if (!run.grading) {
        section.style.display = "none";
        return;
      }

      const grading = run.grading;
      section.style.display = "block";
      // Reset to collapsed
      content.classList.remove("open");
      document.getElementById("grades-arrow").classList.remove("open");

      const summary = grading.summary || {};
      const expectations = grading.expectations || [];

      let html = '<div style="padding: 1rem;">';

      // Summary line
      const passRate = summary.pass_rate != null
        ? Math.round(summary.pass_rate * 100) + "%"
        : "?";
      const badgeClass = summary.pass_rate >= 0.8 ? "grade-pass" : summary.pass_rate >= 0.5 ? "" : "grade-fail";
      html += '<div class="grades-summary">';
      html += '<span class="grade-badge ' + badgeClass + '">' + passRate + '</span>';
      html += '<span>' + (summary.passed || 0) + ' passed, ' + (summary.failed || 0) + ' failed of ' + (summary.total || 0) + '</span>';
      html += '</div>';

      // Assertions list
      html += '<ul class="assertion-list">';
      for (const exp of expectations) {
        const statusClass = exp.passed ? "pass" : "fail";
        const statusIcon = exp.passed ? "\u2713" : "\u2717";
        html += '<li class="assertion-item">';
        html += '<span class="assertion-status ' + statusClass + '">' + statusIcon + '</span>';
        html += '<span>' + escapeHtml(exp.text) + '</span>';
        if (exp.evidence) {
          html += '<div class="assertion-evidence">' + escapeHtml(exp.evidence) + '</div>';
        }
        html += '</li>';
      }
      html += '</ul>';

      html += '</div>';
      content.innerHTML = html;
    }

    function toggleGrades() {
      const content = document.getElementById("grades-content");
      const arrow = document.getElementById("grades-arrow");
      content.classList.toggle("open");
      arrow.classList.toggle("open");
    }

    // ---- Previous outputs (collapsible) ----
    function renderPrevOutputs(run) {
      const section = document.getElementById("prev-outputs-section");
      const content = document.getElementById("prev-outputs-content");
      const prevOutputs = (EMBEDDED_DATA.previous_outputs || {})[run.id];

      if (!prevOutputs || prevOutputs.length === 0) {
        section.style.display = "none";
        return;
      }

      section.style.display = "block";
      // Reset to collapsed
      content.classList.remove("open");
      document.getElementById("prev-outputs-arrow").classList.remove("open");

      // Render the files into the content area
      content.innerHTML = "";
      const wrapper = document.createElement("div");
      wrapper.style.padding = "1rem";

      for (const file of prevOutputs) {
        const fileDiv = document.createElement("div");
        fileDiv.className = "output-file";

        const header = document.createElement("div");
        header.className = "output-file-header";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = file.name;
        header.appendChild(nameSpan);
        const dlBtn = document.createElement("a");
        dlBtn.className = "dl-btn";
        dlBtn.textContent = "Download";
        dlBtn.download = file.name;
        dlBtn.href = getDownloadUri(file);
        header.appendChild(dlBtn);
        fileDiv.appendChild(header);

        const fc = document.createElement("div");
        fc.className = "output-file-content";

        if (file.type === "text") {
          const pre = document.createElement("pre");
          pre.textContent = file.content;
          fc.appendChild(pre);
        } else if (file.type === "image") {
          const img = document.createElement("img");
          img.src = file.data_uri;
          img.alt = file.name;
          fc.appendChild(img);
        } else if (file.type === "pdf") {
          const iframe = document.createElement("iframe");
          iframe.src = file.data_uri;
          fc.appendChild(iframe);
        } else if (file.type === "xlsx") {
          renderXlsx(fc, file.data_b64);
        } else if (file.type === "binary") {
          const a = document.createElement("a");
          a.className = "download-link";
          a.href = file.data_uri;
          a.download = file.name;
          a.textContent = "Download " + file.name;
          fc.appendChild(a);
        }

        fileDiv.appendChild(fc);
        wrapper.appendChild(fileDiv);
      }

      content.appendChild(wrapper);
    }

    function togglePrevOutputs() {
      const content = document.getElementById("prev-outputs-content");
      const arrow = document.getElementById("prev-outputs-arrow");
      content.classList.toggle("open");
      arrow.classList.toggle("open");
    }

    // ---- Feedback (saved to server -> feedback.json) ----
    function saveCurrentFeedback() {
      const run = EMBEDDED_DATA.runs[currentIndex];
      const text = document.getElementById("feedback").value;

      if (text.trim() === "") {
        delete feedbackMap[run.id];
      } else {
        feedbackMap[run.id] = text;
      }

      // Build reviews array from map
      const reviews = [];
      for (const [run_id, feedback] of Object.entries(feedbackMap)) {
        if (feedback.trim()) {
          reviews.push({ run_id, feedback, timestamp: new Date().toISOString() });
        }
      }

      fetch("/api/feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reviews, status: "in_progress" }),
      }).then(() => {
        document.getElementById("feedback-status").textContent = "Saved";
      }).catch(() => {
        // Static mode or server unavailable  no-op on auto-save,
        // feedback will be downloaded on final submit
        document.getElementById("feedback-status").textContent = "Will download on submit";
      });
    }

    // ---- Done ----
    function showDoneDialog() {
      // Save current textarea to feedbackMap (but don't POST yet)
      const run = EMBEDDED_DATA.runs[currentIndex];
      const text = document.getElementById("feedback").value;
      if (text.trim() === "") {
        delete feedbackMap[run.id];
      } else {
        feedbackMap[run.id] = text;
      }

      // POST once with status: complete  include ALL runs so the model
      // can distinguish "no feedback" (looks good) from "not reviewed"
      const reviews = [];
      const ts = new Date().toISOString();
      for (const r of EMBEDDED_DATA.runs) {
        reviews.push({ run_id: r.id, feedback: feedbackMap[r.id] || "", timestamp: ts });
      }
      const payload = JSON.stringify({ reviews, status: "complete" }, null, 2);
      fetch("/api/feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: payload,
      }).then(() => {
        document.getElementById("done-overlay").classList.add("visible");
      }).catch(() => {
        // Server not available (static mode)  download as file
        const blob = new Blob([payload], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "feedback.json";
        a.click();
        URL.revokeObjectURL(url);
        document.getElementById("done-overlay").classList.add("visible");
      });
    }

    function closeDoneDialog() {
      // Reset status back to in_progress
      saveCurrentFeedback();
      document.getElementById("done-overlay").classList.remove("visible");
    }

    // ---- Toast ----
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("visible");
      setTimeout(() => toast.classList.remove("visible"), 2000);
    }

    // ---- Keyboard nav ----
    document.addEventListener("keydown", (e) => {
      // Don't capture when typing in textarea
      if (e.target.tagName === "TEXTAREA") return;

      if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
        e.preventDefault();
        navigate(-1);
      } else if (e.key === "ArrowRight" || e.key === "ArrowDown") {
        e.preventDefault();
        navigate(1);
      }
    });

    // ---- Util ----
    function getDownloadUri(file) {
      if (file.data_uri) return file.data_uri;
      if (file.data_b64) return "data:application/octet-stream;base64," + file.data_b64;
      if (file.type === "text") return "data:text/plain;charset=utf-8," + encodeURIComponent(file.content);
      return "#";
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // ---- View switching ----
    function switchView(view) {
      document.querySelectorAll(".view-tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".view-panel").forEach(p => p.classList.remove("active"));
      document.querySelector(`[onclick="switchView('${view}')"]`).classList.add("active");
      document.getElementById("panel-" + view).classList.add("active");
    }

    // ---- Benchmark rendering ----
    function renderBenchmark() {
      const data = EMBEDDED_DATA.benchmark;
      if (!data) return;

      // Show the tabs
      document.getElementById("view-tabs").style.display = "flex";

      const container = document.getElementById("benchmark-content");
      const summary = data.run_summary || {};
      const metadata = data.metadata || {};
      const notes = data.notes || [];

      let html = "";

      // Header
      html += "<h2 style='font-family: Poppins, sans-serif; margin-bottom: 0.5rem;'>Benchmark Results</h2>";
      html += "<p style='color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1.25rem;'>";
      if (metadata.skill_name) html += "<strong>" + escapeHtml(metadata.skill_name) + "</strong> &mdash; ";
      if (metadata.timestamp) html += metadata.timestamp + " &mdash; ";
      if (metadata.evals_run) html += "Evals: " + metadata.evals_run.join(", ") + " &mdash; ";
      html += (metadata.runs_per_configuration || "?") + " runs per configuration";
      html += "</p>";

      // Summary table
      html += '<table class="benchmark-table">';

      function fmtStat(stat, pct) {
        if (!stat) return "";
        const suffix = pct ? "%" : "";
        const m = pct ? (stat.mean * 100).toFixed(0) : stat.mean.toFixed(1);
        const s = pct ? (stat.stddev * 100).toFixed(0) : stat.stddev.toFixed(1);
        return m + suffix + "  " + s + suffix;
      }

      function deltaClass(val) {
        if (!val) return "";
        const n = parseFloat(val);
        if (n > 0) return "benchmark-delta-positive";
        if (n < 0) return "benchmark-delta-negative";
        return "";
      }

      // Discover config names dynamically (everything except "delta")
      const configs = Object.keys(summary).filter(k => k !== "delta");
      const configA = configs[0] || "config_a";
      const configB = configs[1] || "config_b";
      const labelA = configA.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
      const labelB = configB.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
      const a = summary[configA] || {};
      const b = summary[configB] || {};
      const delta = summary.delta || {};

      html += "<thead><tr><th>Metric</th><th>" + escapeHtml(labelA) + "</th><th>" + escapeHtml(labelB) + "</th><th>Delta</th></tr></thead>";
      html += "<tbody>";

      html += "<tr><td><strong>Pass Rate</strong></td>";
      html += "<td>" + fmtStat(a.pass_rate, true) + "</td>";
      html += "<td>" + fmtStat(b.pass_rate, true) + "</td>";
      html += '<td class="' + deltaClass(delta.pass_rate) + '">' + (delta.pass_rate || "") + "</td></tr>";

      // Time (only show row if data exists)
      if (a.time_seconds || b.time_seconds) {
        html += "<tr><td><strong>Time (s)</strong></td>";
        html += "<td>" + fmtStat(a.time_seconds, false) + "</td>";
        html += "<td>" + fmtStat(b.time_seconds, false) + "</td>";
        html += '<td class="' + deltaClass(delta.time_seconds) + '">' + (delta.time_seconds ? delta.time_seconds + "s" : "") + "</td></tr>";
      }

      // Tokens (only show row if data exists)
      if (a.tokens || b.tokens) {
        html += "<tr><td><strong>Tokens</strong></td>";
        html += "<td>" + fmtStat(a.tokens, false) + "</td>";
        html += "<td>" + fmtStat(b.tokens, false) + "</td>";
        html += '<td class="' + deltaClass(delta.tokens) + '">' + (delta.tokens || "") + "</td></tr>";
      }

      html += "</tbody></table>";

      // Per-eval breakdown (if runs data available)
      const runs = data.runs || [];
      if (runs.length > 0) {
        const evalIds = [...new Set(runs.map(r => r.eval_id))].sort((a, b) => a - b);

        html += "<h3 style='font-family: Poppins, sans-serif; margin-bottom: 0.75rem;'>Per-Eval Breakdown</h3>";

        const hasTime = runs.some(r => r.result && r.result.time_seconds != null);
        const hasErrors = runs.some(r => r.result && r.result.errors > 0);

        for (const evalId of evalIds) {
          const evalRuns = runs.filter(r => r.eval_id === evalId);
          const evalName = evalRuns[0] && evalRuns[0].eval_name ? evalRuns[0].eval_name : "Eval " + evalId;

          html += "<h4 style='font-family: Poppins, sans-serif; margin: 1rem 0 0.5rem; color: var(--text);'>" + escapeHtml(evalName) + "</h4>";
          html += '<table class="benchmark-table">';
          html += "<thead><tr><th>Config</th><th>Run</th><th>Pass Rate</th>";
          if (hasTime) html += "<th>Time (s)</th>";
          if (hasErrors) html += "<th>Crashes During Execution</th>";
          html += "</tr></thead>";
          html += "<tbody>";

          // Group by config and render with average rows
          const configGroups = [...new Set(evalRuns.map(r => r.configuration))];
          for (let ci = 0; ci < configGroups.length; ci++) {
            const config = configGroups[ci];
            const configRuns = evalRuns.filter(r => r.configuration === config);
            if (configRuns.length === 0) continue;

            const rowClass = ci === 0 ? "benchmark-row-with" : "benchmark-row-without";
            const configLabel = config.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());

            for (const run of configRuns) {
              const r = run.result || {};
              const prClass = r.pass_rate >= 0.8 ? "benchmark-delta-positive" : r.pass_rate < 0.5 ? "benchmark-delta-negative" : "";
              html += '<tr class="' + rowClass + '">';
              html += "<td>" + configLabel + "</td>";
              html += "<td>" + run.run_number + "</td>";
              html += '<td class="' + prClass + '">' + ((r.pass_rate || 0) * 100).toFixed(0) + "% (" + (r.passed || 0) + "/" + (r.total || 0) + ")</td>";
              if (hasTime) html += "<td>" + (r.time_seconds != null ? r.time_seconds.toFixed(1) : "") + "</td>";
              if (hasErrors) html += "<td>" + (r.errors || 0) + "</td>";
              html += "</tr>";
            }

            // Average row
            const rates = configRuns.map(r => (r.result || {}).pass_rate || 0);
            const avgRate = rates.reduce((a, b) => a + b, 0) / rates.length;
            const avgPrClass = avgRate >= 0.8 ? "benchmark-delta-positive" : avgRate < 0.5 ? "benchmark-delta-negative" : "";
            html += '<tr class="benchmark-row-avg ' + rowClass + '">';
            html += "<td>" + configLabel + "</td>";
            html += "<td>Avg</td>";
            html += '<td class="' + avgPrClass + '">' + (avgRate * 100).toFixed(0) + "%</td>";
            if (hasTime) {
              const times = configRuns.map(r => (r.result || {}).time_seconds).filter(t => t != null);
              html += "<td>" + (times.length ? (times.reduce((a, b) => a + b, 0) / times.length).toFixed(1) : "") + "</td>";
            }
            if (hasErrors) html += "<td></td>";
            html += "</tr>";
          }
          html += "</tbody></table>";

          // Per-assertion detail for this eval
          const runsWithExpectations = {};
          for (const config of configGroups) {
            runsWithExpectations[config] = evalRuns.filter(r => r.configuration === config && r.expectations && r.expectations.length > 0);
          }
          const hasAnyExpectations = Object.values(runsWithExpectations).some(runs => runs.length > 0);
          if (hasAnyExpectations) {
            // Collect all unique assertion texts across all configs
            const allAssertions = [];
            const seen = new Set();
            for (const config of configGroups) {
              for (const run of runsWithExpectations[config]) {
                for (const exp of (run.expectations || [])) {
                  if (!seen.has(exp.text)) {
                    seen.add(exp.text);
                    allAssertions.push(exp.text);
                  }
                }
              }
            }

            html += '<table class="benchmark-table" style="margin-top: 0.5rem;">';
            html += "<thead><tr><th>Assertion</th>";
            for (const config of configGroups) {
              const label = config.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
              html += "<th>" + escapeHtml(label) + "</th>";
            }
            html += "</tr></thead><tbody>";

            for (const assertionText of allAssertions) {
              html += "<tr><td>" + escapeHtml(assertionText) + "</td>";

              for (const config of configGroups) {
                html += "<td>";
                for (const run of runsWithExpectations[config]) {
                  const exp = (run.expectations || []).find(e => e.text === assertionText);
                  if (exp) {
                    const cls = exp.passed ? "benchmark-delta-positive" : "benchmark-delta-negative";
                    const icon = exp.passed ? "\u2713" : "\u2717";
                    html += '<span class="' + cls + '" title="Run ' + run.run_number + ': ' + escapeHtml(exp.evidence || "") + '">' + icon + "</span> ";
                  } else {
                    html += " ";
                  }
                }
                html += "</td>";
              }
              html += "</tr>";
            }
            html += "</tbody></table>";
          }
        }
      }

      // Notes
      if (notes.length > 0) {
        html += '<div class="benchmark-notes">';
        html += "<h3>Analysis Notes</h3>";
        html += "<ul>";
        for (const note of notes) {
          html += "<li>" + escapeHtml(note) + "</li>";
        }
        html += "</ul></div>";
      }

      container.innerHTML = html;
    }

    // ---- Start ----
    init();
    renderBenchmark();
  </script>
</body>
</html>
